amends "package://github.com/jdx/hk/releases/download/v1.35.0/hk@1.35.0#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v1.35.0/hk@1.35.0#/Builtins.pkl"

local formatters = new Mapping<String, Step> {
    ["prettier"] = (Builtins.prettier) {
        batch = false
    }
    ["newlines"] = Builtins.newlines
    ["shfmt"] = Builtins.shfmt
    ["mixed_line_ending"] = Builtins.mixed_line_ending
    ["fix_smart_quotes"] = Builtins.fix_smart_quotes
    ["trailing_whitespace"] = Builtins.trailing_whitespace
}

local linters = new Mapping<String, Step> {
//     ["lychee"] = Builtins.lychee
    ["detect_private_key"] = Builtins.detect_private_key
    ["check_added_large_files"] = Builtins.check_added_large_files
    ["shellcheck"] = (Builtins.shellcheck) {
        fix = ""
        check = "shellcheck -x --color=always {{files}}"
    }
    ["trufflehog"] {
        // always check the whole workspace and git history
        workspace_indicator = "hk.pkl"
        check = "trufflehog git --fail --no-update --log-level=-1 file://{{workspace}} 2>/dev/null"

        // scan only files selected by hk, respecting `hk check --all`
        // check = "trufflehog --fail --no-update filesystem {{files}}"
    }
    ["gitleaks"] {
        // always check the whole workspace and git history
        workspace_indicator = "hk.pkl"
        check = "gitleaks git --no-banner --log-level=fatal"
    }
}

hooks {
    ["pre-commit"] {
        fix = true
        stash = "git"
        steps = new Mapping<String, Step> { ...formatters ...linters }
    }
    ["check"] {
        fix = false
        steps = new Mapping<String, Step> { ...formatters ...linters }
    }
    ["fix"] {
        fix = true
        steps = formatters
    }
}
