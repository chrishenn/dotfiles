amends "package://github.com/jdx/hk/releases/download/v1.19.0/hk@1.19.0#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v1.19.0/hk@1.19.0#/Builtins.pkl"

local formatters = new Mapping<String, Step> {
    ["prettier"] = Builtins.prettier
    ["newlines"] = Builtins.newlines
    ["shfmt"] = (Builtins.shfmt) {
        // the "check" is broken in the shfmt builtin: always throws errors
        check = "shfmt -l -s {{files}}"
    }
}

local linters = new Mapping<String, Step> {
    ["shellcheck"] = (Builtins.shellcheck) {
        fix = ""
        check = "shellcheck -x --color=always {{files}}"
    }
    ["trufflehog"] {
        // always check the whole workspace and git history
        workspace_indicator = "hk.pkl"
        check = "mise x -- trufflehog git --fail --no-update --log-level=-1 file://{{workspace}} 2>/dev/null"

        // scan only files selected by hk, respecting `hk check --all`
        // check = "mise x -- trufflehog --fail --no-update filesystem {{files}}"
    }
    ["gitleaks"] {
        // always check the whole workspace and git history
        workspace_indicator = "hk.pkl"
        check = "mise x -- gitleaks detect --no-banner --log-level=fatal --source {{workspace}}"
    }
}

hooks {
    ["pre-commit"] {
        fix = true
        stash = "git"
        steps = new Mapping<String, Step> {...formatters ...linters}
    }
    ["check"] {
      fix = false
      steps = new Mapping<String, Step> {...formatters ...linters}
    }
    ["fix"] {
        fix = true
        steps = formatters
    }
}
